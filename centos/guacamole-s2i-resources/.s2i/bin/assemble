#!/bin/bash -e
#
# S2I assemble script for the 'guacamole-s2i' image.
# The 'assemble' script builds your application source so that it is ready to run.
#
# For more information refer to the documentation:
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#

# Source code provided to STI is at ${HOME}/source
LOCAL_SOURCE_DIR=${HOME}/source
mkdir -p $LOCAL_SOURCE_DIR

DEPLOY_DIR=$JWS_HOME/webapps

# the subdirectory within LOCAL_SOURCE_DIR from where we should copy build artifacts
ARTIFACT_DIR=${ARTIFACT_DIR-target}

function get_extra_scripts () {
  mkdir ${JWS_HOME}/guacamole

  curl -k ${GUACAMOLE_SCRIPTS_URL}/download-guacamole.sh -O ${JWS_HOME}/guacamole/download-guacamole.sh
  curl -k ${GUACAMOLE_SCRIPTS_URL}/download-jdbc-auth.sh -O ${JWS_HOME}/guacamole/download-jdbc-auth.sh
  curl -k ${GUACAMOLE_SCRIPTS_URL}/initdb.sh -O ${JWS_HOME}/guacamole/initdb.sh
  curl -k ${GUACAMOLE_SCRIPTS_URL}/start.sh -O ${JWS_HOME}/guacamole/start.sh

}




# Copy the source for compilation
cp -ad /tmp/src/* $LOCAL_SOURCE_DIR

if [ -d $LOCAL_SOURCE_DIR/configuration ]; then
  echo "Copying config files from project..."
  cp -v $LOCAL_SOURCE_DIR/configuration/* $JWS_HOME/conf/
fi

get_extra_scripts

${JWS_HOME}/guacamole/download-guacamole.sh "$GUAC_VERSION" $JWS_HOME/webapps
${JWS_HOME}/guacamole/download-jdbc-auth.sh "$GUAC_JDBC_VERSION" $JWS_HOME/guacamole

mv $JWS_HOME/webapps/guacamole.war $JWS_HOME/webapps/ROOT.war 

sed -i "s/ln -s \/opt\/guacamole/ln -s ${JWS_HOME}\/guacamole/g" $JWS_HOME/guacamole/start.sh

sed -i "s/cd \/usr\/local\/tomcat/cd ${JWS_HOME}\/bin/g" $JWS_HOME/guacamole/start.sh



